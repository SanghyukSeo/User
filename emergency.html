<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Event-aid</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="popup.css">
</head>

<body>
  
  <header>
    <button class="back-button" onclick="history.back()">
    <img src="back.svg" alt="Back">
  </button>
  <img src="Assets/Logo.svg" alt="Event Aid Logo" class="logo">
</header>

<div class="emergency-section">
  <p class="emergency-title"></p>
  <div class="emergency-grid">
    <div class="emergency-option" onclick="selectEmergency('Fainting', this)">
    <img src="Assets/Group2.svg" alt="Fainting Icon">
    <span>FAINT</span>
  </div>
  <div class="emergency-option" onclick="selectEmergency('Substance Abuse', this)">
    <img src="Assets/Group.svg" alt="Substance Abuse Icon">
    <span>SUBSTANCE</span>
  </div><!--
  <div class="emergency-option" onclick="selectEmergency('Dehydration', this)">
    <img src="Assets/Dehydration.svg" alt="Dehydration Icon">
    <span>DEHYDRATION</span>
  </div> -->
  <div class="emergency-option" onclick="selectEmergency('Fighting', this)">
    <img src="Assets/fighting.svg" alt="Fighting Icon">
    <span>FIGHT</span>
  </div>
  <div class="emergency-option" onclick="selectEmergency('Other', this)">
    <img src="Assets/Dehydration.svg" alt="Other Icon">
    <span>OTHER</span>
  </div>
  </div>
</div>



  <div class="tab-content active-tab" id="home">
    <!-- 제거 또는 일반 버튼만 유지 -
    <button class="alert-btn aid-btn" onclick="startReport('Non-Life Threatening')">
      General help
    </button> -->
    <div id="map-container"></div>
  </div>

  
  <!-- Emergency 버튼은 화면 맨 아래에 고정 -->
  <button class="fixed-emergency-btn" onclick="startReport()">

    <img src="Assets/Voice_left.svg" alt="" class="icon">
    REQUEST HELP
    <img src="Assets/Voice.svg" alt="" class="icon">
  </button>
  

  <div class="tab-content" id="info">
    <p>Event Aid is an innovative emergency response platform created to improve on-site safety at large public gatherings such as music festivals, sports events, and outdoor celebrations. Designed for rapid, mobile-based incident reporting, the platform empowers attendees to immediately alert medical responders while pinpointing exact GPS locations. With a clean, user-friendly interface and mobile-first design, Event Aid transforms the way emergency teams receive and respond to calls for help, making large-scale events safer and more accessible for everyone.</p>
    <img src="mit_info.jpg" alt="Info"/>
  </div>

  <div class="tab-content" id="history">
    <p>The concept for Event Aid was born during the Spring 2025 Product Design and Development course at the Massachusetts Institute of Technology (MIT). Developed by a dynamic team of two MIT students and three collaborators from the Rhode Island School of Design (RISD), the project addressed a critical pain point: delayed emergency response during densely packed festivals and sporting events. With over 2,000 major U.S. events held annually and thousands of outdoor rescue operations, the team recognized a significant gap in real-time medical communication. Event Aid emerged as a cutting-edge, user-centered solution aimed at accelerating care delivery in high-density environments — ultimately improving safety and outcomes for everyone involved.</p>
    <img src="mit_history.jpg" alt="History"/>
  </div>

  <div class="tab-content" id="venue" style="overflow:auto; max-height:70vh;">
    <div id="zoom-container" style="overflow:auto; max-height:70vh; max-width:100%; touch-action:pinch-zoom;">
      <img id="zoom-map" src="venue_map.jpg" style="width:100%; height:auto;"/>
    </div>
  </div>


  <div id="popupOverlay" style="display:block;"></div>
  <!-- ✅ 제보자 정보 입력 팝업 (수정된 버전) -->
<div class="popup" id="popupReporterInfo" style="display:block;">
  
  <div class="popup-content">
    <div class="popup-icon">
      <img src="Assets/ambulance-icon.svg" alt="Help is on the way">
    </div>
    <h2>Help is on the way</h2>
    <p class="popup-subtext">Few more steps left.</p>

    <form id="reporterForm">
      <div class="popup-form-group">
        <input type="text" id="rname" name="rname" placeholder="Your Name" required>
        <input type="tel" id="rphone" name="rphone" placeholder="Your Phone #" required>
      </div>
    </form>
  </div>

  <div class="popup-buttons">
    <button type="submit" form="reporterForm" class="submit-btn">Next</button>
    <button type="button" class="cancel-btn" onclick="cancelRequest()">Cancel Request</button>
  </div>
</div>

<!-- ✅ Request Submitted 화면 -->
<div class="popup" id="popupRequestSubmitted" style="display:block;">
  
  <div class="popup-content">
    <div class="popup-icon1">
      <img src="Assets/check-icon.svg" alt="Success">
    </div>
    <h2>Request Submitted</h2>
    <p>Help is on the way.</p>
  </div>

  <div class="popup-buttons">
    <button class="submit-btn" onclick="openMoreInfo()">Add More Information</button>
    <button class="cancel-btn" onclick="cancelRequest()">Return Home</button>
  </div>
</div>
<!-- ✅ 추가 정보 입력 팝업 -->
<div class="popup" id="popupMoreInfo" style="display:none;">
  
  <div class="popup-content" id="moreInfoStep1">
    <h2>Appearance Details</h2>
    <p>* Optional</p>
    <form id="descriptionForm">
      <div class="popup-form-group">
        <input type="text" name="oinfo" placeholder="What does the person look like?">
      </div>
    </form>
  </div>

  <div class="popup-content" id="moreInfoStep2" style="display:none;">
    <h2>Medication Details </h2>
    <p>* Optional</p>
    <form id="medicationForm">
      <div class="popup-form-group">
        <input type="text" name="meds" placeholder="Medications currently taken?">
      </div>
    </form>
  </div>

  <div class="popup-buttons" id="medicationButtons">
    <button type="button" class="submit-btn" onclick="goToMedication()">Next</button>
    <button type="button" class="cancel-btn" onclick="goBackToDescription()">Back</button>
  </div>
</div>
<script>
  function goToMedication() {
    document.getElementById('moreInfoStep1').style.display = 'none';
    document.getElementById('moreInfoStep2').style.display = 'block';
  }
  
  function goBackToDescription() {
    const step2Visible = document.getElementById('moreInfoStep2').style.display === 'block';
    
    if (step2Visible) {
      // Step2에서 Back 누르면 Step1으로 돌아가기
      document.getElementById('moreInfoStep2').style.display = 'none';
      document.getElementById('moreInfoStep1').style.display = 'block';
    } else {
      // Step1에서 Back 누르면 이전 화면 (popupRequestSubmitted)로 돌아가기
      document.getElementById('popupMoreInfo').style.display = 'none';
      document.getElementById('popupRequestSubmitted').style.display = 'block';
    }
  }
  </script>
  <!--
  <div class="popup" id="popupForm" style="display:block;">
    <h2 style="color:red; text-align:center; margin:0.5em 0 0.3em;">HELP IS ON THE WAY</h2>
    <p style="margin:0.2em 0 0.4em;">Please stay nearby and fill out the details about the individual in need.</p>
    <form id="helpForm">
      <input id="uid" name="uid" type="hidden"/>
      <input id="authtok" name="authtok" type="hidden"/>
      <input id="etype" name="etype" type="hidden"/>
      <input id="lat" name="lat" type="hidden"/>
      <input id="long" name="long" type="hidden"/>

      <div style="display:flex;flex-direction:column;gap:0.5em;align-items:center;">
        <div style="width:75%;">
          <div class="popup-grid">
            <select name="awake"><option hidden selected value="">Awake</option><option>Unknown</option><option>Yes</option><option>No</option></select>
            <select name="breathing"><option hidden selected value="">Breathing</option><option>Unknown</option><option>Yes</option><option>No</option></select>
            <select name="vomiting"><option hidden selected value="">Vomiting</option><option>Unknown</option><option>None</option><option>Significant</option><option>Minor</option></select>
            <select name="bleeding"><option hidden selected value="">Bleeding</option><option>None</option><option>Significant</option><option>Minor</option></select>
            <select name="mood"><option hidden selected value="">Demeanor</option><option>Unknown</option><option>Calm</option><option>Hysterical</option></select>
            <select name="danger"><option hidden selected value="">Danger</option><option>Unknown</option><option>No</option><option>Self</option><option>Others</option></select>
            <select name="substances"><option hidden selected value="">Substances</option><option>Unknown</option><option>Drugs</option><option>Alcohol</option><option>Drugs &amp; Alcohol</option></select>
            <select name="scene"><option hidden selected value="">Scene</option><option>Unknown</option><option>Safe</option><option>Unsafe</option></select>
          </div>
          <input name="meds" placeholder="Current Medications" autocomplete="off"/>
          <input name="allergies" placeholder="Known Allergies" autocomplete="off"/>
          <input name="conditions" placeholder="Pre-existing Conditions" autocomplete="off"/>
          <input name="oinfo" placeholder="Other Information" autocomplete="off"/>
          <input name="cname" placeholder="Name of Person Needing Aid" autocomplete="name"/>
          <input name="rname" placeholder="Name of Person Reporting" autocomplete="name"/>
          <input name="rphone" placeholder="Phone #" autocomplete="tel"/>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;gap:1em;">
        <button class="submit-btn" type="submit">Submit Info</button>
        <button class="cancel-btn" type="button" onclick="cancelRequest()">Cancel Request</button>
      </div>
    </form>
  </div>

-->




  <script>
  
    /*

    EMRGENCY 타입 선택



    function selectEmergency(type, buttonElement) {
      selectedType = type;
  
      // 모든 버튼 초기화
      document.querySelectorAll('.emergency-option').forEach(btn => {
        btn.style.backgroundColor = '';
        btn.querySelector('img').style.filter = ''; // SVG 필터 초기화 (흰색 해제)
      });
  
      // 선택한 버튼 스타일 변경
      buttonElement.style.backgroundColor = 'red';
      buttonElement.querySelector('img').style.filter = 'invert(1)'; // SVG를 흰색으로
  
      console.log(`Selected Emergency Type: ${selectedType}`);
    }
      */function selectEmergency(type, buttonElement) {
  selectedType = type;

// 모든 버튼에서 selected 클래스 제거
document.querySelectorAll('.emergency-option').forEach(btn => {
  btn.classList.remove('selected');
});

// 클릭한 버튼에 selected 클래스 추가
buttonElement.classList.add('selected');

console.log(`Selected Emergency Type: ${selectedType}`);
}
  
    function startReport() {
      if (!selectedType) {
        alert('Please select an emergency type first.');
        return;
      }
  
      navigator.geolocation.getCurrentPosition(pos => {
        const initData = new FormData();
        initData.append('etype', selectedType);
        initData.append('lat', pos.coords.latitude);
        initData.append('long', pos.coords.longitude);
  
        fetch('init_report.php', { method: 'POST', body: initData })
          .then(r => r.json())
          .then(d => {
            if (d.status === 'success') {
              currentUID = d.uid;
              currentToken = d.authtok;
              document.getElementById('uid').value = currentUID;
              document.getElementById('authtok').value = currentToken;
              document.getElementById('etype').value = selectedType;
              document.getElementById('lat').value = pos.coords.latitude;
              document.getElementById('long').value = pos.coords.longitude;
              document.getElementById('popupForm').style.display = 'block';
            } else {
              alert('Init failed: ' + d.message);
            }
          })
          .catch(e => { console.error(e); alert('Init error'); });
      }, _ => alert('Unable to get location'));
    }
  

    function cancelRequest() {
      const f = new FormData();
      f.append('uid', currentUID);
      f.append('authtok', currentToken);
      f.append('status', 'Canceled');
      fetch('cancel_report.php', { method: 'POST', body: f })
        .then(r => r.json())
        .then(d => {
          alert(d.status === 'success' ? 'Request canceled.' : 'Cancel failed: ' + d.message);
          document.getElementById('popupForm').style.display = 'none';
        })
        .catch(e => { console.error(e); alert('Cancel error'); });
    }
  















    function initMap() {
      const map = new google.maps.Map(document.getElementById('map-container'), {
        center: { lat: 42.3601, lng: -71.0942 },
        zoom: 15
      });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const me = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          new google.maps.Marker({
            position: me,
            map,
            title: 'You Are Here',
            icon: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
          });
          map.setCenter(me);

          // 여기부터 오버레이 추가
          const overlayBounds = {
            north: me.lat + 0.001, // 중심 좌표 기준 약간 북쪽
            south: me.lat - 0.001, // 약간 남쪽
            east: me.lng + 0.001,  // 약간 동쪽
            west: me.lng - 0.001   // 약간 서쪽
          };

          const groundOverlay = new google.maps.GroundOverlay(
            'https://www.gillettestadium.com/wp-content/uploads/2024/08/2024_CONCERT_SEATING_CHART_SIPAV.jpg', // 덮을 이미지 URL
            overlayBounds
          );

          groundOverlay.setMap(map);
        });
      }
    }

    window.onload = initMap;


















// 팝업 열기 및 닫기

    function openPopup(popupId) {
  document.getElementById('popupOverlay').style.display = 'block';
  document.getElementById(popupId).style.display = 'block';
}

function closePopup(popupId) {
  document.getElementById('popupOverlay').style.display = 'none';
  document.getElementById(popupId).style.display = 'none';
}
// 추가 정보 제출 이벤트
let currentUID = null, currentToken = null;
let selectedType = null; // 선택한 Emergency 타입

// ✅ Emergency 타입 선택
function selectEmergency(type, buttonElement) {
  selectedType = type;

  document.querySelectorAll('.emergency-option').forEach(btn => {
    btn.classList.remove('selected');
  });

  buttonElement.classList.add('selected');

  console.log(`Selected Emergency Type: ${selectedType}`);
}

// ✅ Request Help 버튼 클릭 → 제보자 입력 팝업 열기
function startReport() {
  if (!selectedType) {
    alert('Please select an emergency type first.');
    return;
  }
  openPopup('popupReporterInfo');
}

// ✅ 제보자 입력 폼 제출
document.getElementById('reporterForm').addEventListener('submit', function(e) {
  e.preventDefault();

  navigator.geolocation.getCurrentPosition(pos => {
    const initData = new FormData();
    initData.append('etype', selectedType);
    initData.append('lat', pos.coords.latitude);
    initData.append('long', pos.coords.longitude);
    initData.append('rname', document.getElementById('rname').value);
    initData.append('rphone', document.getElementById('rphone').value);

    fetch('init_report.php', { method: 'POST', body: initData })
      .then(r => r.json())
      .then(d => {
        if (d.status === 'success') {
          currentUID = d.uid;
          currentToken = d.authtok;
          document.getElementById('popupReporterInfo').style.display = 'none';
          document.getElementById('popupRequestSubmitted').style.display = 'block';
        } else {
          alert('Init failed: ' + d.message);
        }
      })
      .catch(e => { console.error(e); alert('Init error'); });
  }, _ => alert('Unable to get location'));
});

// ✅ Add More Info 버튼 누르면 MoreInfo 화면 열기
function openMoreInfo() {
  document.getElementById('popupRequestSubmitted').style.display = 'none';
  document.getElementById('popupMoreInfo').style.display = 'block';
}

// ✅ Description 작성 후 Medication으로 이동
function goToMedication() {
  document.getElementById('moreInfoStep1').style.display = 'none';
  document.getElementById('moreInfoStep2').style.display = 'block';

  // Fainting이면 Skip 버튼 추가
  if (selectedType === 'Fainting' && !document.getElementById('skipButton')) {
    const skipBtn = document.createElement('button');
    skipBtn.className = 'cancel-btn';
    skipBtn.textContent = 'Skip';
    skipBtn.type = 'button';
    skipBtn.id = 'skipButton';
    skipBtn.onclick = fadeAndRedirect;
    document.getElementById('medicationButtons').appendChild(skipBtn);
  }
}

// ✅ Medication 입력 후 제출
document.getElementById('medicationForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const f = new FormData(this);
  f.append('uid', currentUID);
  f.append('authtok', currentToken);

  fetch('update_report.php', { method: 'POST', body: f })
    .then(r => r.json())
    .then(d => {
      if (d.status === 'success') {
        fadeAndRedirect();
      } else {
        alert('Update failed: ' + d.message);
      }
    })
    .catch(e => { console.error(e); alert('Update error'); });
});

// ✅ 요청 취소 (Cancel Request 버튼 누르면 홈으로)
function cancelRequest() {
  const f = new FormData();
  f.append('uid', currentUID);
  f.append('authtok', currentToken);
  f.append('status', 'Canceled');

  fetch('cancel_report.php', { method: 'POST', body: f })
    .then(r => r.json())
    .then(d => {
      window.location.href = 'index.html';
    })
    .catch(e => { console.error(e); alert('Cancel error'); });
}

// ✅ 제출 성공 후 부드럽게 홈 이동
function fadeAndRedirect() {
  const popups = document.querySelectorAll('.popup');
  popups.forEach(popup => popup.classList.add('fade-out'));

  setTimeout(() => {
    window.location.href = 'success.html';
  }, 600);
}
/*
    function initMap() {
      const map = new google.maps.Map(document.getElementById('map-container'), {
        center: { lat: 42.3601, lng: -71.0942 }, zoom: 15
      });
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const me = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          new google.maps.Marker({
            position: me, map, title: 'You Are Here',
            icon: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
          });
          map.setCenter(me);
        });
      }
    }
      */
  </script>
  
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAlZPcXdktuxgglm7tC4IkiHK2LMxpPfv4&callback=initMap"></script>
</body>
</html>
